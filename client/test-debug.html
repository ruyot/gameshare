<!DOCTYPE html>
<html>
<head>
    <title>GameShare Debug Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }
        #log {
            background: #000;
            border: 1px solid #0f0;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .error { color: #f00; }
        .info { color: #0ff; }
        .success { color: #0f0; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover {
            background: #0a0;
        }
        input {
            background: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            margin: 5px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>GameShare WebRTC Debug Test</h1>
    
    <div>
        <input type="text" id="signalingUrl" placeholder="Signaling URL" value="wss://gameshare-clientview.fly.dev/signaling" style="width: 400px;">
        <input type="text" id="sessionId" placeholder="Session ID" value="default-session">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <h2>Connection Log:</h2>
    <div id="log"></div>
    
    <h2>Video Stream:</h2>
    <video id="gameVideo" autoplay playsinline style="width: 640px; height: 480px; background: #000; border: 1px solid #0f0;"></video>

    <script>
        let ws = null;
        let pc = null;
        let sessionId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function connect() {
            const signalingUrl = document.getElementById('signalingUrl').value;
            sessionId = document.getElementById('sessionId').value;
            
            log('Connecting to ' + signalingUrl);
            
            ws = new WebSocket(signalingUrl);
            
            ws.onopen = () => {
                log('WebSocket connected', 'success');
                
                // Send join message
                const joinMsg = {
                    type: 'join',
                    session_id: sessionId,
                    client_type: 'client'
                };
                ws.send(JSON.stringify(joinMsg));
                log('Sent join message: ' + JSON.stringify(joinMsg));
                
                // Setup peer connection
                setupPeerConnection();
            };
            
            ws.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                log('Received: ' + JSON.stringify(message));
                
                switch (message.type) {
                    case 'joined':
                        log('Successfully joined session', 'success');
                        break;
                        
                    case 'offer':
                        await handleOffer(message);
                        break;
                        
                    case 'ice-candidate':
                        await handleIceCandidate(message);
                        break;
                        
                    case 'error':
                        log('Error: ' + message.message, 'error');
                        break;
                }
            };
            
            ws.onerror = (error) => {
                log('WebSocket error: ' + error, 'error');
            };
            
            ws.onclose = () => {
                log('WebSocket disconnected', 'error');
            };
        }
        
        function setupPeerConnection() {
            log('Setting up peer connection');
            
            pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            pc.ontrack = (event) => {
                log('Received track: ' + event.track.kind, 'success');
                if (event.track.kind === 'video') {
                    const video = document.getElementById('gameVideo');
                    video.srcObject = event.streams[0];
                    log('Video track attached to video element', 'success');
                }
            };
            
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidateMsg = {
                        type: 'ice-candidate',
                        candidate: event.candidate.candidate,
                        sdp_mid: event.candidate.sdpMid,
                        sdp_mline_index: event.candidate.sdpMLineIndex,
                        session_id: sessionId
                    };
                    ws.send(JSON.stringify(candidateMsg));
                    log('Sent ICE candidate: ' + event.candidate.candidate);
                }
            };
            
            pc.onconnectionstatechange = () => {
                log('Connection state: ' + pc.connectionState, 
                    pc.connectionState === 'connected' ? 'success' : 'info');
            };
            
            pc.oniceconnectionstatechange = () => {
                log('ICE connection state: ' + pc.iceConnectionState,
                    pc.iceConnectionState === 'connected' ? 'success' : 'info');
            };
        }
        
        async function handleOffer(message) {
            log('Handling offer');
            
            try {
                await pc.setRemoteDescription({
                    type: 'offer',
                    sdp: message.sdp
                });
                log('Set remote description (offer)', 'success');
                
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                log('Created answer', 'success');
                
                const answerMsg = {
                    type: 'answer',
                    sdp: answer.sdp,
                    session_id: sessionId
                };
                
                ws.send(JSON.stringify(answerMsg));
                log('Sent answer to host', 'success');
                log('Answer message: ' + JSON.stringify(answerMsg).substring(0, 200) + '...');
            } catch (error) {
                log('Error handling offer: ' + error, 'error');
            }
        }
        
        async function handleIceCandidate(message) {
            log('Handling ICE candidate: ' + message.candidate);
            
            try {
                await pc.addIceCandidate({
                    candidate: message.candidate,
                    sdpMid: message.sdp_mid,
                    sdpMLineIndex: message.sdp_mline_index
                });
                log('Added ICE candidate', 'success');
            } catch (error) {
                log('Error adding ICE candidate: ' + error, 'error');
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            if (pc) {
                pc.close();
                pc = null;
            }
            log('Disconnected', 'info');
        }
    </script>
</body>
</html>